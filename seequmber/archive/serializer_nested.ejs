<!DOCTYPE html>
<html>
    <head>
        <title>Features</title>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <link rel="stylesheet" href="http://maxcdn.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap.min.css">
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
        <script src="http://maxcdn.bootstrapcdn.com/bootstrap/3.2.0/js/bootstrap.min.js"></script>
        <link href='http://fonts.googleapis.com/css?family=Lato' rel='stylesheet' type='text/css'>
        <style>
          body {
            font-family: Lato, sans-serif;
            color: #395a6b;
          }
          table {
            width: 60em;
          }
          table, tr, th, td {
            text-align: left;
            border: 0px;
            border-collapse: collapse;
            margin: 0px;
            padding: 5px;
          }
          .pass {
            background-color: #DDFFDD;
          }
          .fail {
            background-color: #FFDDDD;
          }
          .skipped {
            background-color: #FFFFDD;
          }
        </style>
    </head>
    <body>
<%
var feature = data;

var getTag = function(tags, lineNumber) {
    var exists = false;
    tags.forEach(function(tag) {
        if (tag.getLine() + 1 === lineNumber) {
            if (tag.getName() === '@manual') {
                exists = true;
            }
        }
    });
    return exists;
};

function write() {
    var pass = true;
    var scenarios = feature.getFeatures();
    scenarios.syncForEach(function(scenario) {
        pass = (pass && writeScenario(scenario, false));
    });
%>
        <table class="Feature" border=1>
            <tr class= <%= (pass) ? "\"pass\"" : "\"fail\"" %> >
                <td colspan=6><%= writeFirstLine(feature) %></td>
            </tr>
<%
    checkForDescription(feature);
    checkForBackground(feature);
    scenarios.syncForEach(function(scenario) {
        writeScenario(scenario, true);
        emptyRow();
    });
%>
        </table>
<%
}

function writeDescription(description) {
    var lines = description.split('\n');
%>
            <table class="Description" border=1>
                <tr>
                    <td colspan=6>
<%
    lines.forEach(function(line) {
%>
                        <%= line %><br>
<%
        });
%>
                    </td>
                </tr>
            </table>
<%
}

function writeBackground(background) {
    var steps = background.getSteps();
%>
            <table class="Background" border=1>
                <tr>
                    <td colspan=6><%= writeFirstLine(background) %></td>
                </tr>
<%
    checkForDescription(background);
    steps.syncForEach(function(step) {
        writeStep(step, true, true);
    });
%>
            </table>
<%
}

function writeScenario(scenario, htmlOut) {
    var pass = true;
    var steps = scenario.getSteps();
    var tags = [];
    if (scenario.getTags) {
        tags = scenario.getTags();
        if (getTag(tags, scenario.getLine())) {
            steps.syncForEach(function(step) {
                pass = (pass && writeStep(step, false, false));
            });
            if (htmlOut){
%>
            <table class="Scenario" border=1>
                <tr class= <%= (pass) ? "\"pass\"" : "\"fail\"" %> >
                    <td colspan=6><%= writeFirstLine(scenario) %></td>
                </tr>
<%
                checkForDescription(scenario);
                steps.syncForEach(function(step) {
                    writeStep(step, false, true);
                });
%>
            </table>
<%
            }
        }
    }
    return pass;
}

function writeStep(step, back, htmlOut) {
    var pass = true;
    var firstLine = step.getKeyword() + step.getName();
    if (step.hasAttachment() && step.hasTestResults()) {
        var tests = step.getTestResults().getTestResults();
        tests.syncForEach(function(test) {
            pass = (pass && (test.raw()[0] !== 'FAIL'));
        });
    }
    if (htmlOut) {
%>
                <table class="Step" border=1>
<%
        if (back) {
%>
                    <tr>
<%
        } else {
%>
                    <tr class= <%= (pass) ? "\"pass\"" : "\"fail\"" %> >
<%      
        }
%>
                        <td>&nbsp;</td>
                        <td colspan=5><%= firstLine %></td>
                    </tr>
<%
        if (step.hasAttachment() && step.hasTestResults()) {
%>
                    <table class="test" border=1>
<%
            tests.syncForEach(function(test) {
                writeTest(test.raw());
            });
%>
                    </table>
<%
            if (step.hasDataTable() && step.getDataTable().raw()[0].length !== 4) {
                var rows = step.getDataTable().getRows();
%>
                    <table class="dataTable" border=1>
                        <tr class= <%= (pass) ? "\"pass\"" : "\"fail\"" %> >
<%
                rows.syncForEach(function(row) {
                    writeRawTable(row.raw());
                });
%>
                        </tr>
                    </table>
<%
            }
        }
%>
                </table>
<%
    }
    return pass;
}

function writeRawTable(raw) {
%>
                        <td></td><td></td>
<%
    raw.forEach(function(element) {
%>
                        <td><%= element %></td>
<%
    });
}

function writeTest(raw) {
    var keyword = '';
    switch (raw[0]) {
        case 'PASS':
            keyword = '"pass"';
            break;
        case 'FAIL':
            keyword = '"fail"';
            break;
        case 'SKIPPED':
            keyword = '"skipped"';
            break;
        default:
            keyword = '"pass"';
    }
%>
                        <tr class= <%= keyword%> >
                            <td></td><td></td>
<%
    raw.forEach(function(element) {
%>
                            <td><%= element %></td>
<%
    });
%>
                        </tr>
<%
}

function checkForDescription(element) {
    if (element.getDescription() && element.getDescription().length > 0) {
        var description = element.getDescription();
        writeDescription(description);
        emptyRow();
    }
}

function checkForBackground(element) {
    if (element.getBackground()) {
        var background = element.getBackground();
        writeBackground(background);
        emptyRow();
    }
}

function writeFirstLine(element) {
    return element.getKeyword() + ': ' + element.getName();
}
function emptyRow() {
%>
            <tr>
                <td colspan=6>
                </td>
            </tr>
<%
}
write();
%>
    </body>
</html>
